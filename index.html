{% extends "sidebar.html" %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>第一組交通事故熱區預測</title>
    <!-- css連結 -->
    <link rel="stylesheet" href="style.css">




    <!-- JQuerry連結 -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

    <!-- JS連結 -->
    <script src="script.js"></script>

    <!-- Font-Aweson小圖示連結 -->
    <script rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></script>
    <script src="https://kit.fontawesome.com/edac1df2ff.js" crossorigin="anonymous"></script>

    <!-- Boostrap連結 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>
    <!-- Leaflet官網貼上 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
</head>


<body>

    <div class="container-all">
        <!-- 左邊container -->
        <div class="container-left">
            <!-- 導覽列Navbar -->
            <nav id="sidebar">
                <!-- 展開/縮起來按鈕     -->
                <button type="button" id="collapse" class="collapse-btn">
                    <i class="fas fa-align-left"></i>
                </button>


                <!-- List列表 -->
                <ul class="list-unstyled">
                    <p>
                        第一組
                    </p>

                    <li>
                        <a href="#">團隊介紹<i class="fa-solid fa-car"></i></a>
                    </li>
                    <li>
                        <a href="#map.html">地圖預測<i class="fa-regular fa-map"></i></a>
                    </li>
                    <li>
                        <a href="#da">資料分析
                            <i class="fa-solid fa-chart-line"></i>
                        </a>
                    </li>

                    <li><a href="#weather">即時天氣<i class="fa-solid fa-cloud-sun-rain"></i></a>
                        </i>
                    </li>

                    <li><a href="#">即時路況<i class="fa-solid fa-magnifying-glass-location">
                            </i>
                        </a>
                    </li>
                </ul>

            </nav>
        </div>

        <!-- 右邊container -->
        <div class="container-right">
            <div class="container-right2">
                <h2>地圖</h2>
                <button id="btn_request1">取得科技執法圖標</button>
                <button id="btn_request">取得事故熱區</button>
            </div>
            <div id="map"></div>


            <!-- 官網貼上 -->
            <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
                integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

            <script>
                var map = L.map('map').setView([25.04899756571732, 121.51368522729861], 13);

                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                //設定圖層群組
                let layerGroup = null;
                let arrMarkers = [];

                // 按鈕事件，取得 科技執法座標的json回傳資料，response要等取得json後放進去，暫定是array
                document.querySelector('button#btn_request1').
                    addEventListener('click', function (event) {
                        fetch('http://127.0.0.1:5000/map', {
                            method: 'GET'
                        }).then(function (response) {

                            return response.json()

                        }).then(function (arr) {
                            console.log(arr)
                            //刪除先前的markers，如果layerGroup不為空，及圖層有內容的話就清空
                            if (layerGroup != null && map.hasLayer(layerGroup)) {
                                layerGroup.clearLayers();
                                map.removeLayer(layerGroup);
                                //變數初始化
                                layerGroup = null;
                                arrMarkers = [];
                            }

                            for (let o of arr) {
                                //建立 markers
                                let marker = L.marker([o['Latitude'], o['Longitude']])
                                    .bindPopup(`${o['Type']}`)
                                    .openPopup();
                                //自訂事件
                                marker.addEventListener('click', function (event) {
                                    console.log(o);
                                });
                                //將 markers 各別放到空陣列 arrMarkers 當中
                                arrMarkers.push(marker);
                            }


                            //迴圈執行完畢後，將 arrMarkers 放到 layerGroup 當中
                            layerGroup = L.layerGroup(arrMarkers);

                            //將 layerGroup 放到 map 當中
                            layerGroup.addTo(map);


                        });
                    });


            </script>
        </div>
    </div>
</body>

</html>